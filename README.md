# [SOLVED] naga-error
This crate is designed to demonstrate a circumstance in which Naga is unable to
translate WGSL into functioning SPIR-V.

## The Issue
Any SPIR-V binary generated from the `src/template.wgsl` file is not functional
in the WGPU render pipeline in `src/main.rs`, regardless of whether Naga is
being used as a standalone CLI or as a library. However, using Tint to translate
the `src/template.wgsl` file into SPIR-V does produce a functional SPIR-V
binary. Using `src/template.wgsl` directly in the WGPU render pipeline also
works.

Using Naga to translate the WGSL source to SPIR-V, either throug the CLI or as a
library, produces a shader that, when run in this render pipeline, produces a
blank image that is the same color as the clear color. Non-Naga shader sources,
when run in this render pipeline, produce a blue triangle in the center of the
image.

## The Solution
My issue was caused by WGPU backface culling my triangle. This is because Naga,
by default translates from WGSL native coordinate-space to SPIR-V native
coordinate-space when translating WGSL to SPIR-V which involves performing
Y-flipping. This is why my entire triangle was being backface culled.

To solve this issue remove the `ADJUST_COORDINATE_SPACE` WriterFlag from the
SPIR-V backend options:
```rust
back::spv::Options {
    // Don't have `WriterFlags::ADJUST_COORDINATE_SPACE`
    flags: back::spv::WriterFlags::empty(),
    ..Default::default()
}
```

## System Information
 * OS: Linux Kubuntu 20.04.2 LTS
 * Rust Version: rustc 1.55.0-nightly (f586d79d1 2021-06-13)
 * Naga Version: master#efd416d96448d0c749d332b857b67bed3b7fc66e
 * WGPU Version: 0.8.1
 * Tint Version: main#52b6a004b8b74ca2750b927bd020fdd8352db4fa
 * Vulkan Instance Version: 1.2.131
 * GPU String: GeForce GTX 1060 6GB

## Running
When run, this crate will produce an `output.png` file containing the output
from the WGPU render pipeline. If the `use-naga-lib` feature is enabled, the
program will also produce a `debug.txt` file containing the debug of the Naga
Module and ModuleInfo structures created when parsing and validating the
`src/template.wgsl` file, as well as a `debug.spv` file containing the
translated, non-functional, SPIR-V binary.

This create is designed to be run with only one of the four possible shader
provider features enabled. These shader provider features are:
 * `use-naga-lib` - To use Naga as a library for translating WGSL into SPIR-V.
 * `use-naga-spv` - To use the SPIR-V binary generated by the Naga CLI.
 * `use-tint-spv` - To use the SPIR-V binary generated by the Tint CLI.
 * `use-wgsl-src` - To use the WGSL shader source directly.

## How the SPIR-V Binaries Were Generated
The `template.naga.spv` SPIR-V binary was generated by using the command:
```shell
naga template.wgsl template.naga.spv
```

The `template.tint.spv` SPIR-V binary was generated by using the command:
```shell
tint --format spirv -o template.tint.spv template.wgsl
```
